# Virgin Media Hub 4

Basic python utility to poke a Virgin Media Hub 4. By poke, I mean reboot.

## Overview

It's quickly becoming apparent this isn't going to be as easy as I'd hoped, with a few basic auth'd requests from python. Right now I'm very much leaning towards a "retail power-down" (ie. pulling the power) by using a [Smart Plug](https://www.mylocalbytes.com/products/smart-plug-pm) #NotSponsored via [Home Assistant](https://www.home-assistant.io/).

There is at least one easy-enough option to do this via software, which is to use Selenium to drive the UI. This [repo from andresp](https://github.com/andresp/cablemodem-status) may do the trick already. I believe the Hub 4 is "Arris’s Touchstone TG3492 Telephony Gateway router, which in the United Kingdom has been given the model code of TG3492LG-VMB ... Judging by these specs the Gigabit Connect Box (Hub 4) is a very close match for Arris’s TG3442 router" according to [ISPReview](https://www.ispreview.co.uk/index.php/2019/07/a-look-at-virgin-media-uks-future-hub-4-gigabit-connect-box-router.html).

If I'm going to write something new I want to understand how to authenticate and make the appropriate requests directly.

## Investigation

Initially there is a `POST` to `http://192.168.0.1/php/ajaxSet_Password.php` whihc returns a nonce in the body and a PHPSESSID cookie in the response headers which future requests send.

Response header

`Set-Cookie PHPSESSID=32_char_hex_string_here; path=/; HttpOnly`

Response body

```json
{
  "p_status": "Match",
  "nonce": "some_random_looking_nonce_value_here"
}
```

This would be simple if the credentials were sent via basic auth or similar, but the web UI doesn't use https, at least not to serve the login page on the default IP of <http://192.168.0.1/>.

This is the request bbody which is sent,

```json
{"encryptedBlob":"a_rather_long_hex_encoded_string","salt":"16_char_hex_string","iv":"16_char_hex_string","authData":"encryptData"}
```

Looking at the source code for the homepage there are a couple of interesting looking javascript files in a section commented as `ARRIS ADD START 37130`, these are `scripts/sjcl.js` and `crypto.js`.

`sjcl.js` appears obfuscated and might handle the low level encryption, `crypto.js` is more readable. Inspecting the login page, there is a password entry field and a "Next" button. I can see the on-click method by inspecting the Next button but I've not located the code which implements the on_click event handler yet. The button htlm is `<input id="LoginButton" type="button" value="Next" class="submitBtn" onclick="{ _onclick_1(arguments[0]);}" tabindex="2">`. To be continued...

An observation while looking at the network traffic between my browser and my router shows some data is returned from <http://192.168.0.1/php/ajaxGet_device_networkstatus_data.php> which can be called unauthenticated.

Saving some of the .js files and inspecting them shows some more promising js functions in `base_95x.js`.

From https://stackoverflow.com/questions/23472334/how-to-find-what-code-is-run-by-a-button-or-element-in-chrome-using-developer-to I got to line 1072 in base.js which calls `doLogin();` which calls `handleLogin(...)` line 6094 which is called with username="Unknown", password="", id="Password" and csrEnabled=false.

handleLogin calls `login()` in `base_95x.js` which is a short method. It html-encodes the password, replacing characters `&<>"'`, creates a variable with some config values and then calls `credentialData()`. This is a simple method which parses, encrypts and stringifys the config, since according to the comments "Parse and stringify are needed since encryptData expects an array". Interestingly this is also in a block marked by comments fenced as `//ARRIS ADD START 37130` and `//ARRIS ADD END 37130`.

Looking at `encryptData()` this adds the salt and iv values to the config, either from the saved session storage or generating new values if the user is not already logged in. These are generated by calls to sjclRandomHex(2, 10) which are default numwords and paranoia.

SJCL stands for the Stanford Javascript Crypto Library, which the code and the comments in crypto.js show the crypto.js file is a simple wrapper for scjl. The `sjcl.js` file appears to be a crushed version of the files [maintained here](https://github.com/bit.wiseshiftleft/sjcl/tree/master)

Removing the browser-specific code I've got a working call so far to `php/ajaxSet_Password.php` which returns `Match` and a new nonce in the response body and a session token in the set-cookie response header, which means I've successfully authenticated with the router. First hurdle completed.
